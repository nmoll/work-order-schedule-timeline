<ng-select
  class="zoom-select"
  cdkMonitorSubtreeFocus
  [items]="timescaleOptions"
  bindLabel="label"
  bindValue="value"
  [(ngModel)]="zoomLevel"
  [clearable]="false"
  [searchable]="false"
  aria-label="Timescale select"
>
  <ng-template ng-label-tmp let-item="item">
    <div class="timescale-selector">
      <div class="timescale-selector_label">Timescale</div>
      <div class="timescale-selector_select">
        {{ item.label }}
        <span>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink"
            width="8.47px"
            height="5px"
          >
            <path
              fill="#687196"
              transform="matrix(1.19249e-08 -1 1 1.19249e-08 0 5)"
              d="M1.8564357 4.2863026C1.8564357 4.4239287 1.8977972 4.5583787 1.9751537 4.6722069L2.0297029 4.7524753L2.0297029 4.7524753L4.6055169 7.3499351C4.8099632 7.5560989 4.8092675 7.8887525 4.6039605 8.094059C4.3989043 8.2991152 4.0664425 8.2991152 3.8613861 8.094059L0.35355338 4.5862265C0.15829125 4.3909645 0.15829125 4.0743818 0.35355338 3.8791199L3.8551474 0.37752596C4.0646429 0.16803056 4.4034357 0.16525376 4.6163368 0.37128714L4.6163368 0.37128714L4.6163368 0.37128714C4.8247828 0.57300931 4.8302341 0.90551656 4.6285114 1.1139628C4.6265159 1.1160251 4.6245031 1.118071 4.6224742 1.1201003L2.0297029 3.7128713L2.0297029 3.7128713L1.9475787 3.8845534C1.887579 4.0099835 1.8564357 4.1472602 1.8564357 4.2863026Z"
              fill-rule="evenodd"
            />
          </svg>
        </span>
      </div>
    </div>
  </ng-template>
</ng-select>

<div class="timeline">
  <div
    class="timeline_row-highlight"
    [class.timeline_row-highlight--visible]="rowHover() !== null"
    [style.top]="rowHighlightTop()"
  ></div>
  <div class="timeline_left-panel">
    <div class="timeline_header">Work Center</div>
    @for (workCenter of workCenterStore.workCenters(); track workCenter.docId) {
      <div class="timeline_left-panel-item">
        {{ workCenter.data.name }}
      </div>
    }
  </div>
  <div class="timeline_right-panel">
    <div class="timeline_right-panel-scroller">
      <div class="timeline_header">
        @for (column of timelineColumns(); track column.label) {
          <div class="timeline_month-column-header" [style.width]="columnWidth + 'px'">
            {{ column.label }}

            @if (column.isCurrent) {
              <span #currentColumn class="timeline_current-column-label">Current {{ zoomLevel() }}</span>
            }
          </div>
        }
      </div>

      <div class="timeline_body">
        <div class="timeline_columns">
          @for (column of timelineColumns(); track column.colNumber) {
            <div
              class="timeline_column"
              [class.current]="column.isCurrent"
              [style.width]="columnWidth + 'px'"
            ></div>
          }
        </div>

        @for (row of viewModel().rows; track row.workCenter.docId) {
          <div
            class="timeline_row"
            (mousemove)="onMouseMoveRow(row.workCenter.docId, $event)"
            (mouseleave)="onMouseLeaveRow()"
            (click)="onRowClick(row.workCenter.docId)"
          >
            @for (column of row.columns; track column.label) {
              <div class="timeline_row-column" [style.width]="columnWidth + 'px'"></div>
            }

            @for (workOrder of row.workOrders; track workOrder.workOrder.docId) {
              <div
                class="timeline_work-order"
                [ngClass]="workOrder.workOrder.data.status"
                [style.left]="workOrder.position.left + 'px'"
                [style.width]="workOrder.position.width + 'px'"
                [style.z-index]="ngSelect.isOpen() ? 11 : 10"
                (click)="$event.stopPropagation()"
              >
                <span class="timeline_work-order-name">
                  {{ workOrder.workOrder.data.name }}
                </span>
                <app-work-order-status [status]="workOrder.workOrder.data.status" />
                <ng-select
                  #ngSelect
                  cdkMonitorSubtreeFocus
                  [items]="workOrderActions"
                  [clearable]="false"
                  [searchable]="false"
                  [attr.aria-label]="workOrder.workOrder.data.name + ' action menu'"
                  [ngModel]="''"
                  (change)="
                    onWorkOrderAction(
                      $event,
                      row.workCenter.docId,
                      workOrder.workOrder.docId,
                      ngSelect
                    )
                  "
                >
                  <ng-template ng-label-tmp let-item="item">
                    <button class="timeline_work-order-options-btn">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        fill="currentColor"
                        class="bi bi-three-dots"
                        viewBox="0 0 16 16"
                      >
                        <path
                          d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"
                        />
                      </svg>
                    </button>
                  </ng-template>
                </ng-select>
              </div>
            }

          </div>
        }

        <div
          class="timeline_add-dates-button"
          [class.timeline_add-dates-button--visible]="rowHover()?.addDates?.visible"
          [style.top]="addDatesTop()"
          [style.left]="addDatesPosition().left + 'px'"
          [style.width]="addDatesPosition().width + 'px'"
        >
          @if (rowHover()?.addDates?.visible) {
            <div class="timeline_add-dates-button_tooltip">Click to add dates</div>
          }
        </div>
      </div>
    </div>
  </div>
</div>
